% Creates a simple model

clear;
close all;

simInst = sim.Instance();
endTime = 30 * 60; % 30 minutes


angle = 10;
x = 0:4;
y = 0:4;

[X, Y] = meshgrid(x, y);
X = cosd(angle) * X + sind(angle) * Y;
Y = -sind(angle) * X + cosd(angle) * Y;

trafficGrid = agents.roads.Network(0.25);
simInst.addCallee(trafficGrid);

rng(0); % Set random seed

for i = 1:numel(X)
	
	location.x = X(i);
	location.y = Y(i);
	if any(i == randi(numel(X), 1, numel(X)))
		location.x = location.x + (rand() - 0.5) * 0.8;
		location.y = location.y + (rand() - 0.5) * 0.8;
	end
	trafficGrid.addIntersection(location);
end

for i = 1:(numel(X) - numel(x))
	trafficGrid.addRoad(trafficGrid.intersections{i}, trafficGrid.intersections{i + numel(x)}, randi(10) + 30);
end

for i = 1:numel(Y)
	if (mod(i, numel(y)) == 0)
		continue;
	end
	trafficGrid.addRoad(trafficGrid.intersections{i}, trafficGrid.intersections{i + 1}, randi(10) + 60)
end

% Add garages
x = linspace(0, 4, 4);
y = linspace(0.5, 3.5, 3);

dx = 0.1;
for i = 1:numel(x)
	for j =1:numel(y)
		%for k = -1:2:1
		k = 1;
			gx = x(i) + (k * dx);
			location.x = cosd(angle) * gx + sind(angle) * y(j);
			location.y = -sind(angle) * gx + cosd(angle) * y(j);
			trafficGrid.addGarage(location, 1);
		%end
	end
end

x = linspace(0.5, 3.5, 3);
y = linspace(0, 4, 4);

dy = 0.1;
for i = 1:numel(x)
	for j =1:numel(y)
		%for k = -1:2:1
		k = 1;
			gy = y(j) + (k * dy);
			location.x = cosd(angle) * x(i) + sind(angle) * gy;
			location.y = -sind(angle) * x(i) + cosd(angle) * gy;
			trafficGrid.addGarage(location, 1);
		%end
	end
end

[path, ~] = trafficGrid.findPath(trafficGrid.garages{1}, trafficGrid.garages{end}, 0);

% Make a noram test 
vehicle = agents.vehicles.Vehicle(80, 0);
simInst.addCallee(vehicle);
vehicle.setPath(path);

% Make a test vehicle
vehicle1 = agents.vehicles.Vehicle(40, 5);
simInst.addCallee(vehicle1);
vehicle1.setPath(path);

% Make a follower vehicle that can go faster, starts 5 seconds later
vehicle2 = agents.vehicles.Vehicle(80, 120);
simInst.addCallee(vehicle2);
vehicle2.setPath(path);

vehicle3 = agents.vehicles.Vehicle(80, 125);
simInst.addCallee(vehicle3);
vehicle3.setPath(path);

simInst.runSim(endTime);



fig = trafficGrid.plot();
vehicle1.plot();
title('Slow Vehicle');

fig = trafficGrid.plot();
vehicle2.plot();
title('Normal Vehicle 1');

fig = trafficGrid.plot();
vehicle2.plot();
title('Normal Vehicle 2');

% Plot vehicle speeds
figure;
hold on;
plot(vehicle1.timeHistory, vehicle1.speedHistory)
plot(vehicle2.timeHistory, vehicle2.speedHistory)
plot(vehicle3.timeHistory, vehicle3.speedHistory)
legend('Slow Vehicle', 'Normal Vehicle 1', 'Normal Vehicle 2');

%[path, cost] = trafficGrid.findPath(trafficGrid.garages{1}, trafficGrid.garages{end - 2}, 0);
% disp('Plotting');
% fig = trafficGrid.plot();
% hold on;
% trafficGrid.plotPath(path, fig);


